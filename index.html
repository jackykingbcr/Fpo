<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Baccarat Sniper Max v8.0</title>
    <style>
        :root {
            --bg: #000000;
            --card: #1c1c1e;
            --text: #ffffff;
            --accent: #ffd700;
            --win: #32d74b;
            --loss: #ff453a;
            --border: #333;
            --banker-bg: #ff453a;
            --player-bg: #0a84ff;
            --wait-bg: #555555;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0; padding: 0;
            height: 100vh;
            display: flex; flex-direction: column;
            overflow: hidden;
            transform: translateZ(0);
            backface-visibility: hidden;
        }

        /* ç™»å½•ä¸è®¾ç½®å¼¹çª—å±‚ */
        .overlay-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        .modal-box { 
            width: 85%; max-width: 320px; text-align: center; 
            background: #1c1c1e; padding: 25px 20px; 
            border-radius: 16px; border: 1px solid #333;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }
        .modal-input {
            width: 100%; padding: 12px; margin: 8px 0 15px 0;
            background: #2c2c2e; border: 1px solid #444; color: #fff;
            border-radius: 8px; box-sizing: border-box; font-size: 15px;
            outline: none;
        }
        .modal-input:focus { border-color: var(--accent); }
        .modal-label { text-align: left; color: #aaa; font-size: 12px; font-weight: bold; margin-left: 2px; }
        .modal-btn {
            width: 100%; padding: 14px; background: var(--accent);
            color: #000; font-weight: 800; border: none;
            border-radius: 8px; font-size: 16px; margin-top: 10px;
            cursor: pointer;
        }
        .btn-cancel { background: #444; color: #fff; }

        #appLayer { display: none; height: 100%; flex-direction: column; }

        .header {
            padding: 10px 15px; background: #111;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border);
            position: relative;
        }
        .app-title { 
            font-weight: 800; font-size: 15px; color: #aaa; letter-spacing: 0.5px; 
            position: absolute; left: 0; width: 100%; text-align: center; 
            pointer-events: none; z-index: 1;
        }
        .btn-group-top { display: flex; gap: 8px; z-index: 2; }
        .btn-small {
            background: #333; color: #ccc; border: none;
            padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: bold;
            cursor: pointer;
        }
        .btn-save { color: var(--accent); }
        .btn-reset { color: var(--loss); }
        .btn-setting { background: transparent; border: 1px solid #555; color: #fff; z-index: 2; }

        .dashboard { padding: 10px; background: var(--card); flex-shrink: 0; }
        .pl-display-area { text-align: center; padding: 5px 0 10px 0; }
        .pl-label { font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        .pl-value { font-size: 36px; font-weight: 900; font-family: monospace; line-height: 1.1; }
        
        .comm-row { text-align: center; font-size: 12px; color: #666; margin-bottom: 10px; }
        
        .cum-scores-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-bottom: 15px; }
        .cum-item { 
            background: #2c2c2e; border-radius: 8px; padding: 6px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .cum-label { font-size: 11px; color: #aaa; margin-bottom: 2px; font-weight: bold; text-align: center; }
        .cum-val-box { display: flex; align-items: baseline; gap: 3px; }
        .cum-val { font-size: 16px; font-weight: bold; }
        .cum-rate { font-size: 10px; color: #888; }

        .reg-progress-area { margin-bottom: 8px; padding: 0 4px; }
        .reg-label-row { display: flex; justify-content: space-between; font-size: 10px; color: #888; margin-bottom: 4px; font-weight: bold; }
        .reg-bar-bg { height: 6px; background: #333; border-radius: 3px; overflow: hidden; border: 1px solid #444; }
        .reg-bar-fill { height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent) 0%, var(--win) 100%); box-shadow: 0 0 8px rgba(50, 215, 75, 0.2); transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1); }

        .instr-card {
            background: linear-gradient(135deg, #3a3a3c, #2c2c2e);
            border: 1px solid #444; border-radius: 12px;
            padding: 15px; text-align: center; margin-bottom: 10px;
        }
        .phase-text { font-size: 12px; color: #aaa; margin-bottom: 5px; }
        .main-instr { font-size: 28px; font-weight: 900; line-height: 1.2; display: flex; justify-content: center; align-items: baseline; gap: 10px; }
        
        .wl-container {
            background: #111; border: 1px solid #333; border-radius: 8px;
            padding: 10px; margin-bottom: 10px;
        }
        .wl-stats {
            font-size: 11px; color: #888; margin-bottom: 6px;
            border-bottom: 1px solid #222; padding-bottom: 4px;
            display: flex; justify-content: space-between;
        }
        .wl-list {
            display: flex; flex-wrap: wrap; gap: 4px; font-size: 14px;
            min-height: 20px; max-height: 60px; overflow-y: auto;
            align-content: flex-start;
        }
        .wl-item-win { color: var(--win); }
        .wl-item-loss { color: var(--loss); }

        .side-B { color: var(--banker-bg); }
        .side-P { color: var(--player-bg); }
        .side-Wait { color: #888; }

        .btn-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .btn-big {
            padding: 18px; border: none; border-radius: 10px;
            font-size: 20px; font-weight: bold; color: white;
            box-shadow: 0 4px 0 rgba(0,0,0,0.3);
            transition: transform 0.1s;
            cursor: pointer;
        }
        .bg-b { background: var(--banker-bg); }
        .bg-p { background: var(--player-bg); }
        .btn-big:active { transform: scale(0.96); }

        .table-wrap {
            flex-grow: 1; overflow-y: auto; background: #000;
            border-top: 1px solid var(--border);
            -webkit-overflow-scrolling: touch;
            contain: content;
        }
        table { width: 100%; border-collapse: collapse; font-size: 12px; text-align: center; table-layout: fixed; }
        th { color: #888; padding: 8px 2px; font-weight: bold; border-bottom: 1px solid #333; font-size: 12px; position: sticky; top: 0; background: #1a1a1a; z-index: 10; }
        td { padding: 10px 2px; border-bottom: 1px solid #222; color: #ddd; }

        .win-color { color: var(--win); }
        .loss-color { color: var(--loss); }
        .wait-color { color: #888; }

    </style>
</head>
<body>

    <div id="loginLayer" class="overlay-layer">
        <div class="modal-box">
            <h3 style="color:var(--accent); margin-top:0; margin-bottom:20px;">ç³»ç»Ÿç™»å½•</h3>
            <input type="text" id="u" class="modal-input" placeholder="ç”¨æˆ·å">
            <input type="password" id="p" class="modal-input" placeholder="å¯†ç ">
            <button class="modal-btn" onclick="tryLogin()">ç™» å½•</button>
            <div id="msg" style="color:var(--loss); font-size:12px; margin-top:10px;"></div>
        </div>
    </div>

    <div id="settingsLayer" class="overlay-layer" style="display:none;">
        <div class="modal-box">
            <h3 style="color:#fff; margin-top:0; border-bottom:1px solid #333; padding-bottom:10px;">âš™ï¸ ç­–ç•¥é€‰é¡¹</h3>
            
            <div class="modal-label">ğŸ¯ ç›®æ ‡è§¦å‘æ¡ä»¶ (å…¥åœºæ—¶æœº)</div>
            <select id="selTrigger" class="modal-input">
                <option value="2">AA / BB è§¦å‘ (2è¿èµ·æ­¥)</option>
                <option value="3">AAA / BBB è§¦å‘ (3è¿èµ·æ­¥)</option>
            </select>

            <div class="modal-label">ğŸ“ˆ æ³¨ç é€’å¢ç­–ç•¥ (èµ„é‡‘ç®¡ç†)</div>
            <select id="selBetting" class="modal-input">
                <option value="fib">æ–æ³¢é‚£å¥‘æ•°åˆ— (1, 2, 3, 5, 8...)</option>
                <option value="martingale">é©¬ä¸æ ¼å°”æ•°åˆ— (1, 2, 4, 8, 16...)</option>
            </select>

            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="modal-btn btn-cancel" onclick="closeSettings()">å– æ¶ˆ</button>
                <button class="modal-btn" onclick="applySettings()">ä¿å­˜æ›´æ”¹</button>
            </div>
        </div>
    </div>

    <div id="appLayer">
        <div class="header">
            <button class="btn-small btn-setting" onclick="openSettings()">âš™ï¸ ç­–ç•¥</button>
            <span class="app-title">Sniper Pro Max v8.0</span>
            <div class="btn-group-top">
                <button class="btn-small btn-save" onclick="saveGame(true)">ä¿å­˜</button>
                <button class="btn-small btn-reset" onclick="resetGame()">é‡ç½®</button>
            </div>
        </div>

        <div class="dashboard">
            <div class="pl-display-area">
                <div class="pl-label">16ç»„çª—å£æ€»ç›ˆäº (NET P/L)</div>
                <div class="pl-value win-color" id="totalPL">+0.00</div>
            </div>

            <div class="comm-row" id="gameStatusLabel" style="color: var(--accent); font-size: 14px;">æ¸¸æˆä¸­ - è¿½è¸ªçŠ¶æ€</div>

            <div class="cum-scores-row">
                <div class="cum-item"><span class="cum-label" id="lblFibLevel">æ³¨ç (æ–æ³¢)</span><div class="cum-val-box"><span class="cum-val" id="fibLevel">0</span></div></div>
                <div class="cum-item"><span class="cum-label" id="lblTrigger">ç›®æ ‡å±æ€§</span><div class="cum-val-box"><span class="cum-val" id="targetProp">-</span></div></div>
                <div class="cum-item"><span class="cum-label">è¿å‡»å±‚æ•°</span><div class="cum-val-box"><span class="cum-val" id="streakCount">0</span><span class="cum-rate">/4</span></div></div>
                <div class="cum-item"><span class="cum-label">ä¸‹æ³¨æ¬¡æ•°</span><div class="cum-val-box"><span class="cum-val" id="betCount">0</span></div></div>
            </div>

            <div class="reg-progress-area">
                <div class="reg-label-row"><span>16ç»„çª—å£è¿›åº¦ (WINDOW PROGRESS)</span><span id="regPercent">0%</span></div>
                <div class="reg-bar-bg"><div id="regFill" class="reg-bar-fill"></div></div>
            </div>

            <div class="instr-card">
                <div>
                    <div class="phase-text" id="phaseTag">ç­‰å¾…å¼€å±€ - ç¬¬ 1 ç»„ | ä½ç½® 1</div>
                    <div class="main-instr" id="mainInstr"><span id="instrDir" class="side-Wait">è§‚ æœ›</span><span id="instrAmt" style="font-size:20px; color:#fff"></span></div>
                    <div style="font-size: 10px; color: #888; margin-top: 5px;" id="instrDetail">ç­‰å¾…è§¦å‘ä¸­...</div>
                </div>
            </div>

            <div class="wl-container">
                <div class="wl-stats"><span>ä¸‹æ³¨è®°å½• (1:1èµ”ç‡)</span><span id="wlStatsText">èƒœ: 0 | è´Ÿ: 0 | èƒœç‡: 0%</span></div>
                <div class="wl-list" id="wlList"></div>
            </div>

            <div class="btn-row">
                <button class="btn-big bg-b" onclick="input('B')">å½•å…¥ 0 (åº„)</button>
                <button class="btn-big bg-p" onclick="input('P')">å½•å…¥ 1 (é—²)</button>
            </div>
            <div style="text-align:right; margin-top:5px; display: flex; justify-content: space-between; align-items: center;">
                <button class="btn-small" style="color: #666; background: transparent;" onclick="logout()">é€€å‡ºç™»å½•</button>
                <button class="btn-small" onclick="undo()">æ’¤é”€ (Undo)</button>
            </div>
        </div>

        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th width="15%">ç»„</th>
                        <th width="35%">ç»“æœ(1/2)</th>
                        <th width="25%">åŠ¨ä½œç›ˆäº</th>
                        <th width="25%">æ€»ç›ˆäº</th>
                    </tr>
                </thead>
                <tbody id="gameTable"></tbody>
            </table>
        </div>
    </div>

    <script>
        const CRED = { u: 'jacky', p: '66620598' };
        
        // æ–æ³¢é‚£å¥‘æ³¨ç è¡¨ 
        const FIB = [1, 2, 3, 5, 8, 13, 21, 34, 55, 89, 144, 233, 377, 610, 987, 1597, 2584, 4181, 6765, 10946, 17711, 28657, 46368, 75025, 121393, 196418];

        let S = {
            group: 1,           
            hand: 1,            
            history: [],        
            fibIdx: 0,          
            streak: 0,          
            targetProp: null,   
            totalPL: 0,         
            groupPL: 0,         
            currentH1Res: null, 
            wlHistory: [],      
            records: [],        
            gameStatus: 'PLAYING', 
            stack: [],          
            triggerMode: 2,      // è§¦å‘æ¨¡å¼ (2 = AA/BB, 3 = AAA/BBB)
            bettingMode: 'fib'   // æ³¨ç æ¨¡å¼ ('fib' = æ–æ³¢é‚£å¥‘, 'martingale' = é©¬ä¸æ ¼å°”)
        };
        
        let isProcessing = false;

        window.onload = function() {
            if (localStorage.getItem('bacc_v8_logged_in') === 'true') {
                const sessionS = localStorage.getItem('bacc_v8_session');
                if (sessionS) {
                    S = JSON.parse(sessionS);
                    if(!S.triggerMode) S.triggerMode = 2;
                    if(!S.bettingMode) S.bettingMode = 'fib';
                }
                enterApp();
            }
        };

        function tryLogin() {
            if(document.getElementById('u').value === CRED.u && document.getElementById('p').value === CRED.p) {
                localStorage.setItem('bacc_v8_logged_in', 'true');
                enterApp();
            } else { document.getElementById('msg').innerText = "è´¦å·æˆ–å¯†ç é”™è¯¯"; }
        }

        function enterApp() {
            document.getElementById('loginLayer').style.display = 'none';
            document.getElementById('appLayer').style.display = 'flex';
            updateUI();
        }

        function logout() {
            if(confirm("ç¡®å®šè¦é€€å‡ºå—ï¼Ÿ")) {
                localStorage.removeItem('bacc_v8_logged_in');
                location.reload();
            }
        }

        // --- è®¾ç½®å¼¹çª—é€»è¾‘ ---
        function openSettings() {
            document.getElementById('selTrigger').value = S.triggerMode;
            document.getElementById('selBetting').value = S.bettingMode;
            document.getElementById('settingsLayer').style.display = 'flex';
        }

        function closeSettings() {
            document.getElementById('settingsLayer').style.display = 'none';
        }

        function applySettings() {
            S.triggerMode = parseInt(document.getElementById('selTrigger').value);
            S.bettingMode = document.getElementById('selBetting').value;
            closeSettings();
            autoSaveSession();
            updateUI();
        }

        function autoSaveSession() {
            setTimeout(() => {
                const { stack, ...dataToSave } = S; 
                localStorage.setItem('bacc_v8_session', JSON.stringify(dataToSave));
            }, 0);
        }

        // --- æ ¸å¿ƒï¼šè®¡ç®—å½“å‰ä¸‹æ³¨é‡‘é¢ ---
        function calculateBetAmount() {
            if (S.bettingMode === 'martingale') {
                return Math.pow(2, Math.min(S.fibIdx, 20));
            } else {
                return S.fibIdx < FIB.length ? FIB[S.fibIdx] : FIB[FIB.length - 1];
            }
        }

        // --- æ ¸å¿ƒï¼šåˆ¤å®šå½“å‰åŠ¨ä½œæŒ‡ä»¤ ---
        function getInstruction() {
            if (S.gameStatus === 'WON') return { side: null, amt: 0, msg: "ğŸ¯ æ­¢ç›ˆç¦»åœºï¼4è¿å‡‘é½", detail: "æ¸¸æˆèƒœåˆ©ï¼Œè¯·é‡ç½®å¼€å¯æ–°ä¸€è½®" };
            if (S.gameStatus === 'GAMEOVER') return { side: null, amt: 0, msg: "ğŸ 16ç»„ç»“æŸ", detail: "çª—å£è€—å°½ï¼Œè¯·é‡ç½®" };
            if (S.group > 16) return { side: null, amt: 0, msg: "ç­‰å¾…é‡ç½®", detail: "-" };

            let currentAmt = calculateBetAmount();
            let triggerName = S.triggerMode === 3 ? "AAA / BBB" : "AA / BB";

            if (S.targetProp) {
                let betSide = S.targetProp === 'A' ? 'B' : 'P';
                let targetName = S.targetProp === 'A' ? 'åº„(0)' : 'é—²(1)';
                
                if (S.hand === 1) {
                    return { side: betSide, amt: currentAmt, msg: `ç‹™å‡» ${targetName}`, detail: `åš ${S.targetProp.repeat(4)} è¿å‡» (å±‚æ•°: ${S.streak}/4)` };
                } else {
                    if (S.currentH1Res === betSide) {
                        return { side: null, amt: 0, msg: "è§‚ æœ› (H1å·²ä¸­)", detail: `æœ¬ç»„ç›®æ ‡å·²è¾¾æˆï¼Œéšä¾¿å½•å…¥æ¨è¿›è¿›åº¦` };
                    } else {
                        return { side: betSide, amt: currentAmt, msg: `è¿½æ‰“ ${targetName}`, detail: `H1æœªä¸­ï¼ŒH2ç»§ç»­è¿½æ‰“` };
                    }
                }
            } else {
                return { side: null, amt: 0, msg: "è§‚ æœ›", detail: `ç­‰å¾… ${triggerName} è§¦å‘ä¸­...` };
            }
        }

        function input(res) {
            if (isProcessing) return; 
            isProcessing = true;

            if (S.gameStatus !== 'PLAYING' && S.group > 16) {
                isProcessing = false;
                return;
            }

            // ä¿å­˜çŠ¶æ€ç”¨äºUndo
            const { stack, ...snapshotData } = S;
            S.stack.push(JSON.stringify(snapshotData));
            if (S.stack.length > 20) S.stack.shift(); 

            let instr = getInstruction();
            let actionText = "è§‚æœ›";

            // æ‰§è¡Œä¸‹æ³¨æ¸…ç®—
            if (instr.amt > 0) {
                let isWin = (instr.side === res);
                if (isWin) {
                    S.wlHistory.push('âœ…');
                    S.totalPL += instr.amt;
                    S.groupPL += instr.amt;
                } else {
                    S.wlHistory.push('âŒ');
                    S.totalPL -= instr.amt;
                    S.groupPL -= instr.amt;
                }
                S.fibIdx++; // å‡ºæ‰‹å³é€’å¢
                actionText = `æ‰“${instr.side==='B'?'0':'1'} [${instr.amt}] ${isWin?'èƒœ':'è´Ÿ'}`;
            }

            if (S.hand === 1) {
                S.currentH1Res = res;
                S.hand = 2;
                S.records.unshift({ id: S.group, h1: res, h2: '-', action: actionText, pl: S.groupPL, totalPL: S.totalPL, isComplete: false });
            } else {
                let groupRes = S.currentH1Res + res;
                S.history.push(groupRes);

                if(S.records.length > 0 && !S.records[0].isComplete) {
                    S.records[0].h2 = res;
                    S.records[0].action += (instr.amt>0 ? `<br>æ‰“${instr.side==='B'?'0':'1'} [${instr.amt}] ${instr.side===res?'èƒœ':'è´Ÿ'}` : `<br>è§‚æœ›`);
                    S.records[0].pl = S.groupPL;
                    S.records[0].totalPL = S.totalPL;
                    S.records[0].isComplete = true;
                }

                // --- é“¾æ¡ä¸ç»„å±æ€§åˆ¤å®š ---
                let hasA = groupRes.includes('B');
                let hasB = groupRes.includes('P');

                if (S.targetProp) {
                    if ((S.targetProp === 'A' && hasA) || (S.targetProp === 'B' && hasB)) {
                        S.streak++;
                        if (S.streak >= 4) {
                            S.gameStatus = 'WON'; 
                        }
                    } else {
                        // æ–­è£‚ï¼Œé‡ç½®
                        S.targetProp = null;
                        S.streak = 0;
                    }
                }

                // --- åŠ¨æ€è§¦å‘æ£€æµ‹ (æ”¯æŒ 2è¿ æˆ– 3è¿) ---
                let tLen = S.triggerMode;
                if (!S.targetProp && S.gameStatus === 'PLAYING' && S.history.lengt