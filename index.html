<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Baccarat Sniper Max v10.0 (ç»ˆæç‰ˆ)</title>
    <style>
        :root {
            --bg: #000000;
            --card: #1c1c1e;
            --text: #ffffff;
            --accent: #ffd700;
            --win: #32d74b;
            --loss: #ff453a;
            --border: #333;
            --banker-bg: #ff453a;
            --player-bg: #0a84ff;
            --wait-bg: #555555;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0; padding: 0;
            height: 100vh;
            display: flex; flex-direction: column;
            overflow: hidden;
            transform: translateZ(0);
            backface-visibility: hidden;
            -webkit-user-select: none;
            user-select: none;
        }

        .overlay-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        .modal-box { 
            width: 85%; max-width: 320px; text-align: center; 
            background: #1c1c1e; padding: 25px 20px; 
            border-radius: 16px; border: 1px solid #333;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }
        .modal-input {
            width: 100%; padding: 12px; margin: 8px 0 15px 0;
            background: #2c2c2e; border: 1px solid #444; color: #fff;
            border-radius: 8px; box-sizing: border-box; font-size: 14px;
            outline: none;
        }
        .modal-input:focus { border-color: var(--accent); }
        .modal-label { text-align: left; color: #aaa; font-size: 13px; font-weight: bold; margin-left: 2px; margin-bottom: 5px; }
        .modal-btn {
            width: 100%; padding: 14px; background: var(--accent);
            color: #000; font-weight: 800; border: none;
            border-radius: 8px; font-size: 16px; margin-top: 10px;
            cursor: pointer;
        }
        .btn-cancel { background: #444; color: #fff; }

        #appLayer { display: none; height: 100%; flex-direction: column; }

        .header {
            padding: 10px 15px; background: #111;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border);
            position: relative;
        }
        .app-title { 
            font-weight: 800; font-size: 15px; color: #aaa; letter-spacing: 0.5px; 
            position: absolute; left: 0; width: 100%; text-align: center; 
            pointer-events: none; z-index: 1;
        }
        .btn-group-top { display: flex; gap: 8px; z-index: 2; }
        .btn-small {
            background: #333; color: #ccc; border: none;
            padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: bold;
            cursor: pointer;
        }
        .btn-save { color: var(--accent); }
        .btn-reset { color: var(--loss); }
        .btn-setting { background: transparent; border: 1px solid #555; color: #fff; z-index: 2; }

        .dashboard { padding: 10px; background: var(--card); flex-shrink: 0; }
        .pl-display-area { text-align: center; padding: 5px 0 10px 0; }
        .pl-label { font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        .pl-value { font-size: 36px; font-weight: 900; font-family: monospace; line-height: 1.1; }
        
        .comm-row { text-align: center; font-size: 12px; color: #666; margin-bottom: 10px; }
        
        .cum-scores-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-bottom: 15px; }
        .cum-item { 
            background: #2c2c2e; border-radius: 8px; padding: 6px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .cum-label { font-size: 11px; color: #aaa; margin-bottom: 2px; font-weight: bold; text-align: center; }
        .cum-val-box { display: flex; align-items: baseline; gap: 3px; }
        .cum-val { font-size: 16px; font-weight: bold; }
        .cum-rate { font-size: 10px; color: #888; }

        .reg-progress-area { margin-bottom: 8px; padding: 0 4px; }
        .reg-label-row { display: flex; justify-content: space-between; font-size: 10px; color: #888; margin-bottom: 4px; font-weight: bold; }
        .reg-bar-bg { height: 6px; background: #333; border-radius: 3px; overflow: hidden; border: 1px solid #444; }
        .reg-bar-fill { height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent) 0%, var(--win) 100%); box-shadow: 0 0 8px rgba(50, 215, 75, 0.2); transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1); }

        .instr-card {
            background: linear-gradient(135deg, #3a3a3c, #2c2c2e);
            border: 1px solid #444; border-radius: 12px;
            padding: 15px; text-align: center; margin-bottom: 10px;
        }
        .phase-text { font-size: 12px; color: #aaa; margin-bottom: 5px; }
        .main-instr { font-size: 28px; font-weight: 900; line-height: 1.2; display: flex; justify-content: center; align-items: baseline; gap: 10px; }
        
        .wl-container {
            background: #111; border: 1px solid #333; border-radius: 8px;
            padding: 10px; margin-bottom: 10px;
        }
        .wl-stats {
            font-size: 11px; color: #888; margin-bottom: 6px;
            border-bottom: 1px solid #222; padding-bottom: 4px;
            display: flex; justify-content: space-between;
        }
        .wl-list {
            display: flex; flex-wrap: wrap; gap: 4px; font-size: 14px;
            min-height: 20px; max-height: 60px; overflow-y: auto;
            align-content: flex-start;
        }
        .wl-item-win { color: var(--win); }
        .wl-item-loss { color: var(--loss); }

        .side-B { color: var(--banker-bg); }
        .side-P { color: var(--player-bg); }
        .side-Wait { color: #888; }

        .btn-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .btn-big {
            padding: 18px; border: none; border-radius: 10px;
            font-size: 20px; font-weight: bold; color: white;
            box-shadow: 0 4px 0 rgba(0,0,0,0.3);
            transition: transform 0.1s;
            cursor: pointer;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }
        .bg-b { background: var(--banker-bg); }
        .bg-p { background: var(--player-bg); }
        .btn-big:active { transform: scale(0.96); }

        .table-wrap {
            flex-grow: 1; overflow-y: auto; background: #000;
            border-top: 1px solid var(--border);
            -webkit-overflow-scrolling: touch;
            contain: content;
        }
        table { width: 100%; border-collapse: collapse; font-size: 12px; text-align: center; table-layout: fixed; }
        th { color: #888; padding: 8px 2px; font-weight: bold; border-bottom: 1px solid #333; font-size: 12px; position: sticky; top: 0; background: #1a1a1a; z-index: 10; }
        td { padding: 10px 2px; border-bottom: 1px solid #222; color: #ddd; }

        .win-color { color: var(--win); }
        .loss-color { color: var(--loss); }
        .wait-color { color: #888; }

    </style>
</head>
<body>

    <div id="loginLayer" class="overlay-layer">
        <div class="modal-box">
            <h3 style="color:var(--accent); margin-top:0; margin-bottom:20px;">ç³»ç»Ÿç™»å½•</h3>
            <input type="text" id="u" class="modal-input" placeholder="ç”¨æˆ·å">
            <input type="password" id="p" class="modal-input" placeholder="å¯†ç ">
            <button class="modal-btn" onclick="tryLogin()">ç™» å½•</button>
            <div id="msg" style="color:var(--loss); font-size:12px; margin-top:10px;"></div>
        </div>
    </div>

    <div id="settingsLayer" class="overlay-layer" style="display:none;">
        <div class="modal-box">
            <h3 style="color:#fff; margin-top:0; border-bottom:1px solid #333; padding-bottom:10px;">âš™ï¸ æˆ˜æœ¯å¥—é¤è®¾ç½®</h3>
            
            <div class="modal-label">âš”ï¸ ä¸€é”®åˆ‡æ¢æˆ˜æœ¯ç»„</div>
            <select id="selStrategy" class="modal-input">
                <option value="2_fib">å¥—é¤ 1ï¼š2è¿è§¦å‘ (AA/BB) + æ–æ³¢é‚£å¥‘</option>
                <option value="3_martingale">å¥—é¤ 2ï¼š3è¿è§¦å‘ (AAA/BBB) + é©¬ä¸æ ¼å°”</option>
                <option value="hand_martingale">å¥—é¤ 3ï¼šç»„æ‹¦æˆª (åŒåŒ/å•å•) + é©¬ä¸</option>
            </select>

            <div style="font-size: 11px; color: #888; text-align: left; margin-top: 5px; line-height: 1.4;">
                * å¥—é¤1ï¼šé«˜é¢‘è§¦å‘ï¼Œé‡éœ‡è¡ç¼“æ…¢æ‹‰å‡ã€‚<br>
                * å¥—é¤2ï¼šä½é¢‘é˜²å¾¡ï¼Œä¸€å‡»å¿…æ€å¼ºåˆ¶å›æœ¬ã€‚<br>
                * å¥—é¤3ï¼šåŒå•æµæ°´ä¸¤æ­¥æ‹¦æˆªï¼Œç›ˆåˆ©å³æ­¢ç›ˆã€‚
            </div>

            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="modal-btn btn-cancel" onclick="closeSettings()">å– æ¶ˆ</button>
                <button class="modal-btn" onclick="applySettings()">ä¿å­˜æ›´æ”¹</button>
            </div>
        </div>
    </div>

    <div id="appLayer">
        <div class="header">
            <button class="btn-small btn-setting" onclick="openSettings()">âš™ï¸ ç­–ç•¥</button>
            <span class="app-title">Sniper Pro Max v10.0</span>
            <div class="btn-group-top">
                <button class="btn-small btn-save" onclick="saveGame(true)">ä¿å­˜</button>
                <button class="btn-small btn-reset" onclick="resetGame()">é‡ç½®</button>
            </div>
        </div>

        <div class="dashboard">
            <div class="pl-display-area">
                <div class="pl-label">è´¦æˆ·æ€»ç›ˆäº (NET P/L)</div>
                <div class="pl-value win-color" id="totalPL">+0.00</div>
            </div>

            <div class="comm-row" id="gameStatusLabel" style="color: var(--accent); font-size: 14px;">æ¸¸æˆä¸­ - è¿½è¸ªçŠ¶æ€</div>

            <div class="cum-scores-row">
                <div class="cum-item"><span class="cum-label" id="lblFibLevel">æ³¨ç (æ–æ³¢)</span><div class="cum-val-box"><span class="cum-val" id="fibLevel">0</span></div></div>
                <div class="cum-item"><span class="cum-label" id="lblTrigger">ç›®æ ‡å±æ€§</span><div class="cum-val-box"><span class="cum-val" id="targetProp">-</span></div></div>
                <div class="cum-item"><span class="cum-label" id="lblStreak">è¿å‡»å±‚æ•°</span><div class="cum-val-box"><span class="cum-val" id="streakCount">0</span><span class="cum-rate" id="streakRate">/4</span></div></div>
                <div class="cum-item"><span class="cum-label">ä¸‹æ³¨æ¬¡æ•°</span><div class="cum-val-box"><span class="cum-val" id="betCount">0</span></div></div>
            </div>

            <div class="reg-progress-area">
                <div class="reg-label-row"><span id="lblProgress">16ç»„çª—å£è¿›åº¦ (WINDOW PROGRESS)</span><span id="regPercent">0%</span></div>
                <div class="reg-bar-bg"><div id="regFill" class="reg-bar-fill"></div></div>
            </div>

            <div class="instr-card">
                <div>
                    <div class="phase-text" id="phaseTag">ç­‰å¾…å¼€å±€ - ç¬¬ 1 ç»„ | ä½ç½® 1</div>
                    <div class="main-instr" id="mainInstr"><span id="instrDir" class="side-Wait">è§‚ æœ›</span><span id="instrAmt" style="font-size:20px; color:#fff"></span></div>
                    <div style="font-size: 10px; color: #888; margin-top: 5px;" id="instrDetail">ç­‰å¾…è§¦å‘ä¸­...</div>
                </div>
            </div>

            <div class="wl-container">
                <div class="wl-stats"><span>ä¸‹æ³¨è®°å½• (åªæ˜¾æœ€æ–°150æ¡)</span><span id="wlStatsText">èƒœ: 0 | è´Ÿ: 0 | èƒœç‡: 0%</span></div>
                <div class="wl-list" id="wlList"></div>
            </div>

            <div class="btn-row">
                <button class="btn-big bg-b" onclick="input('B')">å½•å…¥ 0 (åº„)</button>
                <button class="btn-big bg-p" onclick="input('P')">å½•å…¥ 1 (é—²)</button>
            </div>
            <div style="text-align:right; margin-top:5px; display: flex; justify-content: space-between; align-items: center;">
                <button class="btn-small" style="color: #666; background: transparent;" onclick="logout()">é€€å‡ºç™»å½•</button>
                <button class="btn-small" onclick="undo()">æ’¤é”€ (Undo)</button>
            </div>
        </div>

        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th width="15%">ç»„</th>
                        <th width="35%">ç»“æœ(1/2)</th>
                        <th width="25%">åŠ¨ä½œç›ˆäº</th>
                        <th width="25%">æ€»ç›ˆäº</th>
                    </tr>
                </thead>
                <tbody id="gameTable"></tbody>
            </table>
        </div>
    </div>

    <script>
        const CRED = { u: 'jacky', p: '66620598' };
        
        const FIB = [1, 2, 3, 5, 8, 13, 21, 34, 55, 89, 144, 233, 377, 610, 987, 1597, 2584, 4181, 6765, 10946, 17711, 28657, 46368, 75025, 121393, 196418];

        let S = {
            group: 1,           
            hand: 1,            
            history: [],        
            fibIdx: 0,          
            streak: 0,          
            targetProp: null,   
            totalPL: 0,         
            groupPL: 0,         
            currentH1Res: null, 
            wlHistory: [],      
            records: [],        
            gameStatus: 'PLAYING', 
            stack: [],          
            triggerMode: 2,     
            bettingMode: 'fib',
            s3GroupHistory: [], // æ–°å¢ï¼šå¥—é¤3ä¸“å±çš„åŒå•ç»„å±æ€§æµæ°´è®°å½• ('D' æˆ– 'S')
            s3State: 'PHASE1',  
            s3Target: null      
        };
        
        let isProcessing = false;

        window.onload = function() {
            if (localStorage.getItem('bacc_v10_logged_in') === 'true') {
                const sessionS = localStorage.getItem('bacc_v10_session');
                if (sessionS) {
                    S = JSON.parse(sessionS);
                    if(!S.triggerMode) S.triggerMode = 2;
                    if(!S.bettingMode) S.bettingMode = 'fib';
                    if(!S.s3GroupHistory) S.s3GroupHistory = [];
                    if(!S.s3State) S.s3State = 'PHASE1';
                }
                enterApp();
            }
        };

        function tryLogin() {
            if(document.getElementById('u').value === CRED.u && document.getElementById('p').value === CRED.p) {
                localStorage.setItem('bacc_v10_logged_in', 'true');
                enterApp();
            } else { document.getElementById('msg').innerText = "è´¦å·æˆ–å¯†ç é”™è¯¯"; }
        }

        function enterApp() {
            document.getElementById('loginLayer').style.display = 'none';
            document.getElementById('appLayer').style.display = 'flex';
            updateUI();
        }

        function logout() {
            if(confirm("ç¡®å®šè¦é€€å‡ºå—ï¼Ÿ")) {
                localStorage.removeItem('bacc_v10_logged_in');
                location.reload();
            }
        }

        function openSettings() {
            document.getElementById('selStrategy').value = S.triggerMode + '_' + S.bettingMode;
            document.getElementById('settingsLayer').style.display = 'flex';
        }

        function closeSettings() {
            document.getElementById('settingsLayer').style.display = 'none';
        }

        function applySettings() {
            let comboValue = document.getElementById('selStrategy').value.split('_');
            let trig = comboValue[0];
            let newTrig = trig === 'hand' ? 'hand' : parseInt(trig);
            let newBet = comboValue[1];
            
            if (S.triggerMode !== newTrig || S.bettingMode !== newBet) {
                S.triggerMode = newTrig;
                S.bettingMode = newBet;
                softResetEngine();
            }
            
            closeSettings();
            autoSaveSession();
            updateUI();
        }

        function autoSaveSession() {
            setTimeout(() => {
                const { stack, ...dataToSave } = S; 
                localStorage.setItem('bacc_v10_session', JSON.stringify(dataToSave));
            }, 0);
        }

        function calculateBetAmount() {
            if (S.bettingMode === 'martingale') {
                return Math.pow(2, Math.min(S.fibIdx, 20)); 
            } else {
                return S.fibIdx < FIB.length ? FIB[S.fibIdx] : FIB[FIB.length - 1];
            }
        }

        function getInstruction() {
            if (S.gameStatus === 'WON') return { side: null, amt: 0, msg: "ğŸ¯ æ­¢ç›ˆç¦»åœºï¼", detail: "è¾¾æˆç›ˆåˆ©æ”¶ç½‘ï¼Œè¯·é‡ç½®å¼€å¯æ–°ä¸€å±€" };
            if (S.gameStatus === 'GAMEOVER') return { side: null, amt: 0, msg: "ğŸ 16ç»„ç»“æŸ", detail: "çª—å£è€—å°½ï¼Œè¯·é‡ç½®" };
            if (S.triggerMode !== 'hand' && S.group > 16) return { side: null, amt: 0, msg: "ç­‰å¾…é‡ç½®", detail: "-" };

            let currentAmt = calculateBetAmount();

            // ==== å¥—é¤3ï¼šç»„é€»è¾‘ä¸¤æ­¥æ‹¦æˆª (åŒ/å•) ====
            if (S.triggerMode === 'hand') {
                if (S.s3State === 'PHASE2' || S.s3State === 'PHASE3') {
                    let pName = S.s3State === 'PHASE2' ? 'ä¸€è£' : 'äºŒè£';
                    let tName = S.s3Target === 'D' ? 'åŒ(è¿)' : 'å•(è·³)';
                    
                    if (S.hand === 1) {
                        return { side: null, amt: 0, msg: `${pName}æŠ“ ${tName}`, detail: `ç­‰å¾… H1 å¼€å‡ºï¼Œä»¥æŒ‡å¼•æŠ•æ³¨æ–¹å‘` };
                    } else {
                        // å¦‚æœç›®æ ‡æ˜¯åŒ(D)ï¼Œæ‰“ä¸H1ç›¸åŒçš„ï¼›å¦‚æœç›®æ ‡æ˜¯å•(S)ï¼Œæ‰“ä¸H1ç›¸åçš„
                        let betSide = S.s3Target === 'D' ? S.currentH1Res : (S.currentH1Res === 'B' ? 'P' : 'B');
                        return { side: betSide, amt: currentAmt, msg: `${pName}æ‰“ ${tName}`, detail: `æ‹¦æˆªï¼šæ‰“ ${betSide==='B'?'åº„(0)':'é—²(1)'}` };
                    }
                } else {
                    return { side: null, amt: 0, msg: "è§‚ æœ›", detail: S.hand === 1 ? "å¯»æ‰¾çŒç‰©ï¼šç­‰å¾… åŒåŒ æˆ– å•å•..." : "å½•å…¥ H2 åˆ¤å®šå•åŒç»„å±æ€§" };
                }
            }

            // ==== å¥—é¤1 & 2 ====
            let triggerName = S.triggerMode === 3 ? "AAA / BBB" : "AA / BB";
            if (S.targetProp) {
                let betSide = S.targetProp === 'A' ? 'B' : 'P';
                let targetName = S.targetProp === 'A' ? 'åº„(0)' : 'é—²(1)';
                
                if (S.hand === 1) {
                    return { side: betSide, amt: currentAmt, msg: `ç‹™å‡» ${targetName}`, detail: `åš ${S.targetProp.repeat(4)} è¿å‡» (å±‚æ•°: ${S.streak}/4)` };
                } else {
                    if (S.currentH1Res === betSide) {
                        return { side: null, amt: 0, msg: "è§‚ æœ› (H1å·²ä¸­)", detail: `æœ¬ç»„ç›®æ ‡å·²è¾¾æˆï¼Œéšä¾¿å½•å…¥æ¨è¿›è¿›åº¦` };
                    } else {
                        return { side: betSide, amt: currentAmt, msg: `è¿½æ‰“ ${targetName}`, detail: `H1æœªä¸­ï¼ŒH2ç»§ç»­è¿½æ‰“` };
                    }
                }
            } else {
                return { side: null, amt: 0, msg: "è§‚ æœ›", detail: `ç­‰å¾… ${triggerName} è§¦å‘ä¸­...` };
            }
        }

        function input(res) {
            if (isProcessing) return; 
            isProcessing = true;

            try {
                if (S.gameStatus !== 'PLAYING') return;

                const { stack, ...snapshotData } = S;
                S.stack.push(JSON.stringify(snapshotData));
                if (S.stack.length > 20) S.stack.shift(); 

                let instr = getInstruction();
                let actionText = "è§‚æœ›";

                if (instr.amt > 0) {
                    let isWin = (instr.side === res);
                    if (isWin) {
                        S.wlHistory.push('âœ…');
                        S.totalPL += instr.amt;
                        S.groupPL += instr.amt;
                        
                        if (S.triggerMode === 'hand') {
                            S.fibIdx = 0; 
                            S.s3State = 'PHASE1';
                            S.s3Target = null;
                            if (S.totalPL > 0) S.gameStatus = 'WON';
                        }
                    } else {
                        S.wlHistory.push('âŒ');
                        S.totalPL -= instr.amt;
                        S.groupPL -= instr.amt;

                        if (S.triggerMode === 'hand') {
                            S.fibIdx++;
                            if (S.s3State === 'PHASE2') {
                                S.s3State = 'PHASE3'; 
                                // åè½¬æ¢è·¯ï¼šåˆšæ‰ç›®æ ‡æ‰“åŒå¤±è´¥ï¼Œè¯´æ˜å‡ºäº†å•ï¼Œè¡¥åˆ€å°±æ‰“å•
                                S.s3Target = S.s3Target === 'D' ? 'S' : 'D';     
                            } else if (S.s3State === 'PHASE3') {
                                S.s3State = 'PHASE1'; 
                                S.s3Target = null;
                            }
                        }
                    }
                    if (S.triggerMode !== 'hand') S.fibIdx++; 

                    actionText = `æ‰“${instr.side==='B'?'0':'1'} [${instr.amt}] ${isWin?'èƒœ':'è´Ÿ'}`;
                }

                if (S.hand === 1) {
                    S.currentH1Res = res;
                    S.hand = 2;
                    S.records.unshift({ id: S.group, h1: res, h2: '-', action: actionText, pl: S.groupPL, totalPL: S.totalPL, isComplete: false });
                } else {
                    let groupRes = S.currentH1Res + res;
                    S.history.push(groupRes);

                    if(S.records.length > 0 && !S.records[0].isComplete) {
                        S.records[0].h2 = res;
                        S.records[0].action += (instr.amt>0 ? `<br>æ‰“${instr.side==='B'?'0':'1'} [${instr.amt}] ${instr.side===res?'èƒœ':'è´Ÿ'}` : `<br>è§‚æœ›`);
                        S.records[0].pl = S.groupPL;
                        S.records[0].totalPL = S.totalPL;
                        S.records[0].isComplete = true;
                    }

                    // ==== å¥—é¤3ä¸“å±ï¼šç»“ç®—ç»„å•åŒå±æ€§å¹¶æ¨å…¥æµæ°´çº¿ ====
                    if (S.triggerMode === 'hand') {
                        let groupProp = (S.currentH1Res === res) ? 'D' : 'S'; // Dä¸ºåŒ(BB/PP)ï¼ŒSä¸ºå•(BP/PB)
                        S.s3GroupHistory.push(groupProp);

                        // é˜¶æ®µ1è§‚æœ›æ—¶ï¼Œæ£€æŸ¥æ˜¯å¦è§¦å‘è¿ç»­ä¸¤ä¸ªåŒï¼Œæˆ–è¿ç»­ä¸¤ä¸ªå•
                        if (S.s3State === 'PHASE1' && S.s3GroupHistory.length >= 2) {
                            let last2 = S.s3GroupHistory.slice(-2);
                            if (last2[0] === 'D' && last2[1] === 'D') {
                                S.s3State = 'PHASE2';
                                S.s3Target = 'D'; // å‡†å¤‡æŠ“åŒåŒåŒ
                            } else if (last2[0] === 'S' && last2[1] === 'S') {
                                S.s3State = 'PHASE2';
                                S.s3Target = 'S'; // å‡†å¤‡æŠ“å•å•å•
                            }
                        }
                    }

                    // ==== å¥—é¤1 & 2 çš„ç»„é€»è¾‘ ====
                    if (S.triggerMode !== 'hand') {
                        let hasA = groupRes.includes('B');
                        let hasB = groupRes.includes('P');

                        if (S.targetProp) {
                            if ((S.targetProp === 'A' && hasA) || (S.targetProp === 'B' && hasB)) {
                                S.streak++;
                                if (S.streak >= 4) {
                                    S.gameStatus = 'WON'; 
                                }
                            } else {
                                S.targetProp = null;
                                S.streak = 0;
                            }
                        }

                        let tLen = S.triggerMode;
                        if (!S.targetProp && S.gameStatus === 'PLAYING' && S.history.length >= tLen) {
                            let isAllA = true, isAllB = true;
                            for(let i = 1; i <= tLen; i++) {
                                let h = S.history[S.history.length - i];
                                if(!h.includes('B')) isAllA = false;
                                if(!h.includes('P')) isAllB = false;
                            }

                            if (isAllA) {
                                S.targetProp = 'A';
                                S.streak = tLen;
                            } else if (isAllB) {
                                S.targetProp = 'B';
                                S.streak = tLen;
                            }
                        }
                    }

                    S.group++;
                    S.hand = 1;
                    S.currentH1Res = null;
                    S.groupPL = 0;

                    if (S.triggerMode !== 'hand' && S.group > 16 && S.gameStatus === 'PLAYING') {
                        S.gameStatus = 'GAMEOVER';
                    }
                }
            } catch (err) {
                console.error("Input logic error:", err);
            } finally {
                autoSaveSession();
                updateUI();
                setTimeout(() => { isProcessing = false; }, 50); 
            }
        }

        function undo() {
            if (S.stack.length > 0) {
                const lastStack = S.stack;
                S = JSON.parse(S.stack.pop());
                S.stack = lastStack;
                autoSaveSession();
                updateUI();
            }
        }

        function updateUI() {
            window.requestAnimationFrame(() => {
                const wins = S.wlHistory.filter(x => x === 'âœ…').length;
                const losses = S.wlHistory.filter(x => x === 'âŒ').length;
                const winRate = (wins + losses) > 0 ? Math.round((wins / (wins + losses)) * 100) : 0;
                
                document.getElementById('totalPL').innerText = (S.totalPL > 0 ? "+" : "") + S.totalPL;
                document.getElementById('totalPL').className = S.totalPL > 0 ? 'pl-value win-color' : (S.totalPL < 0 ? 'pl-value loss-color' : 'pl-value');
                
                let statusLabel = document.getElementById('gameStatusLabel');
                if (S.triggerMode === 'hand') {
                    if (S.gameStatus === 'WON') {
                        statusLabel.innerText = "ğŸ‰ æŒ‘æˆ˜æˆåŠŸ - ç›ˆåˆ©æ”¶ç½‘ç¦»åœº"; 
                        statusLabel.style.color = "var(--win)";
                    } else {
                        statusLabel.innerText = "ğŸŸ¢ å¥—é¤3è¿è¡Œä¸­ - åŒå•ç»„æ¢è·¯æ‹¦æˆª"; 
                        statusLabel.style.color = "var(--accent)";
                    }
                } else {
                    if(S.gameStatus === 'WON') { statusLabel.innerText = "ğŸ‰ æŒ‘æˆ˜æˆåŠŸ - å·²è§¦å‘4è¿æ­¢ç›ˆç¦»åœº"; statusLabel.style.color = "var(--win)"; }
                    else if(S.gameStatus === 'GAMEOVER') { statusLabel.innerText = "âš ï¸ æ¸¸æˆç»“æŸ - 16ç»„çª—å£è€—å°½"; statusLabel.style.color = "var(--loss)"; }
                    else { statusLabel.innerText = "ğŸŸ¢ å¥—é¤1/2è¿è¡Œä¸­ - åŠ¨æ€è¿½è¸ªæ¨¡å¼"; statusLabel.style.color = "var(--accent)"; }
                }

                document.getElementById('lblFibLevel').innerText = S.bettingMode === 'martingale' ? 'æ³¨ç (é©¬ä¸)' : 'æ³¨ç (æ–æ³¢)';
                document.getElementById('fibLevel').innerText = S.fibIdx;
                
                if (S.triggerMode === 'hand') {
                    document.getElementById('lblTrigger').innerText = 'å½“å‰é˜¶æ®µ';
                    let pName = S.s3State === 'PHASE1' ? 'P1(å¯»çŒ)' : (S.s3State === 'PHASE2' ? 'P2(ä¸€è£)' : 'P3(äºŒè£)');
                    document.getElementById('targetProp').innerText = pName;
                    document.getElementById('targetProp').className = 'cum-val wait-color';

                    document.getElementById('lblStreak').innerText = 'æ”»å‡»ç›®æ ‡';
                    document.getElementById('streakCount').innerText = S.s3Target ? (S.s3Target==='D'?'åŒ(è¿)':'å•(è·³)') : '-';
                    document.getElementById('streakCount').className = S.s3Target ? (S.s3Target==='D'?'cum-val side-B':'cum-val side-P') : 'cum-val';
                    document.getElementById('streakRate').style.display = 'none';

                    if (S.gameStatus === 'WON') {
                        document.getElementById('lblProgress').innerText = 'æ— é™ç»„æµæ°´è¿½è¸ª (WON)';
                        document.getElementById('regPercent').innerText = 'å·²æ­¢ç›ˆ';
                        document.getElementById('regFill').style.width = '100%';
                        document.getElementById('regFill').style.background = 'var(--win)';
                    } else {
                        document.getElementById('lblProgress').innerText = 'æ— é™ç»„æµæ°´è¿½è¸ª (INFINITE)';
                        document.getElementById('regPercent').innerText = 'æ— é™å¾ªç¯';
                        document.getElementById('regFill').style.width = '100%';
                        document.getElementById('regFill').style.background = 'linear-gradient(90deg, #0a84ff 0%, #32d74b 100%)';
                    }
                } else {
                    document.getElementById('lblTrigger').innerText = S.triggerMode === 3 ? 'ç›®æ ‡(3è¿è§¦å‘)' : 'ç›®æ ‡(2è¿è§¦å‘)';
                    document.getElementById('targetProp').innerText = S.targetProp ? (S.targetProp==='A'?'A (æ‰“0)':'B (æ‰“1)') : "æ— ";
                    document.getElementById('targetProp').className = S.targetProp ? (S.targetProp==='A'?'cum-val side-B':'cum-val side-P') : 'cum-val wait-color';

                    document.getElementById('lblStreak').innerText = 'è¿å‡»å±‚æ•°';
                    document.getElementById('streakCount').innerText = S.streak;
                    document.getElementById('streakCount').className = S.streak >= 4 ? 'cum-val win-color' : 'cum-val';
                    document.getElementById('streakRate').style.display = 'inline';

                    document.getElementById('lblProgress').innerText = '16ç»„çª—å£è¿›åº¦ (WINDOW PROGRESS)';
                    let progress = Math.min((S.group - 1 + (S.hand===2?0.5:0)) / 16 * 100, 100);
                    document.getElementById('regFill').style.width = progress + '%';
                    document.getElementById('regFill').style.background = 'linear-gradient(90deg, var(--accent) 0%, var(--win) 100%)';
                    document.getElementById('regPercent').innerText = Math.floor(progress) + '%';
                }

                document.getElementById('betCount').innerText = (wins + losses);
                document.getElementById('wlStatsText').innerText = `èƒœ: ${wins} | è´Ÿ: ${losses} | èƒœç‡: ${winRate}%`;
                
                const wlList = document.getElementById('wlList');
                const displayWL = S.wlHistory.slice(-150);
                wlList.innerHTML = displayWL.map(item => `<span class="${item==='âœ…'?'wl-item-win':'wl-item-loss'}">${item}</span>`).join('');
                wlList.scrollTop = wlList.scrollHeight;

                let instr = getInstruction();
                let infTag = S.triggerMode === 'hand' ? ' (æ— é™)' : '';
                document.getElementById('phaseTag').innerText = `ç¬¬ ${S.triggerMode==='hand'?S.group:Math.min(S.group, 16)} ç»„ | ä½ç½® ${S.hand}${infTag}`;
                
                let dir = document.getElementById('instrDir');
                if (instr.amt === 0) { 
                    dir.innerText = instr.msg; 
                    dir.className = "side-Wait"; 
                    document.getElementById('instrAmt').innerText = ""; 
                } else {
                    dir.innerText = instr.side === 'B' ? "åº„(0)" : "é—²(1)";
                    dir.className = instr.side === 'B' ? "side-B" : "side-P";
                    document.getElementById('instrAmt').innerText = instr.amt;
                }
                document.getElementById('instrDetail').innerText = instr.detail;

                let html = "";
                let displayRecords = S.records.slice(0, 60);
                for(let i=0; i<displayRecords.length; i++) {
                    let rec = displayRecords[i];
                    html += `<tr>
                        <td>G${rec.id}</td>
                        <td style="font-weight:bold; color:#fff">${rec.h1 === 'B' ? '0' : (rec.h1 === 'P' ? '1' : '-')} , ${rec.h2 === 'B' ? '0' : (rec.h2 === 'P' ? '1' : '-')}</td>
                        <td class="${rec.pl>0?'win-color':(rec.pl<0?'loss-color':'wait-color')}" style="font-size:11px">${rec.action || '-'}</td>
                        <td class="${rec.totalPL>0?'win-color':(rec.totalPL<0?'loss-color':'wait-color')}" style="font-weight:bold">${rec.totalPL>0?'+':''}${rec.totalPL}</td>
                    </tr>`;
                }
                document.getElementById('gameTable').innerHTML = html;
            });
        }

        function saveGame(showMsg=false) {
            const { stack, ...saveData } = S;
            let saveObj = { id: Date.now(), date: new Date().toLocaleString(), finalPL: S.totalPL, group: S.group, state: saveData };
            let hist = JSON.parse(localStorage.getItem('bacc_v10_hist')||'[]');
            hist.unshift(saveObj);
            localStorage.setItem('bacc_v10_hist', JSON.stringify(hist.slice(0, 50)));
            if(showMsg) alert("ä¿å­˜æˆåŠŸï¼");
        }
        
        function softResetEngine() {
            S = {
                group: 1, hand: 1, history: [], fibIdx: 0, streak: 0,
                targetProp: null, totalPL: 0, groupPL: 0, currentH1Res: null,
                wlHistory: [], records: [], gameStatus: 'PLAYING', stack: [],
                triggerMode: S.triggerMode,  
                bettingMode: S.bettingMode,
                s3GroupHistory: [],
                s3State: 'PHASE1',
                s3Target: null
            };
            const { stack, ...dataToSave } = S;
            localStorage.setItem('bacc_v10_session', JSON.stringify(dataToSave));
        }

        function resetGame() { 
            if(confirm("ç¡®å®šè¦é‡ç½®å¹¶æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿ")) { 
                softResetEngine();
                updateUI(); 
            } 
        }
    </script>
</body>
</html>
